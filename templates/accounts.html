{% extends "base.html" %}

{% block title %}Accounts - IPTV Proxy{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">IPTV Accounts</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#accountModal" id="add-account-btn">
        <i class="bi bi-plus-circle"></i> Add Account
    </button>
</div>

<div id="accounts-list">
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<!-- Account Modal -->
<div class="modal fade" id="accountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="accountModalLabel">Add Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="accountForm">
                    <input type="hidden" id="accountId">
                    <div class="mb-3">
                        <label for="accountName" class="form-label">Account Name</label>
                        <input type="text" class="form-control" id="accountName" required>
                    </div>
                    <div class="mb-3">
                        <label for="accountServer" class="form-label">Server</label>
                        <input type="text" class="form-control" id="accountServer" placeholder="example.com or http://example.com/" required>
                        <div class="form-text">Enter domain or full URL (http:// and trailing slash will be removed)</div>
                    </div>
                    <div class="mb-3">
                        <label for="accountUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="accountUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="accountPassword" class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="accountPassword" required>
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div class="form-text" id="passwordHint" style="display: none;">Password already set (leave blank to keep current)</div>
                    </div>
                    <div class="mb-3">
                        <label for="accountUserAgent" class="form-label">User Agent</label>
                        <input type="text" class="form-control" id="accountUserAgent" 
                               placeholder="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36">
                        <div class="form-text">Custom user agent string for API requests (leave blank for default)</div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="accountEnabled" checked>
                        <label class="form-check-label" for="accountEnabled">Enabled</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-account-btn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Categories Modal -->
<div class="modal fade" id="categoriesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoriesModalLabel">Categories</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="categoriesContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Credentials Modal -->
<div class="modal fade" id="credentialsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="credentialsModalLabel">Manage Credentials</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>Multiple Credentials:</strong> Add multiple credentials for the same account to enable DVR and Picture-in-Picture support. 
                    Each credential provides additional concurrent stream capacity.
                </div>
                <div id="credentialsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="add-credential-btn">
                    <i class="bi bi-plus-circle"></i> Add Credential
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Credential Modal -->
<div class="modal fade" id="credentialEditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="credentialEditModalLabel">Add Credential</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="credentialForm">
                    <input type="hidden" id="credentialId">
                    <input type="hidden" id="credentialAccountId">
                    <div class="mb-3">
                        <label for="credentialUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="credentialUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="credentialPassword" class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="credentialPassword" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggleCredentialPassword">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div class="form-text" id="credentialPasswordHint" style="display: none;">Password already set (leave blank to keep current)</div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="credentialEnabled" checked>
                        <label class="form-check-label" for="credentialEnabled">Enabled</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-credential-btn">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let accounts = [];
let currentCredentialsAccountId = null;
const modal = new bootstrap.Modal(document.getElementById('accountModal'));
const categoriesModal = new bootstrap.Modal(document.getElementById('categoriesModal'));
const credentialsModal = new bootstrap.Modal(document.getElementById('credentialsModal'));
const credentialEditModal = new bootstrap.Modal(document.getElementById('credentialEditModal'));

async function loadAccounts() {
    try {
        const response = await fetch('/api/accounts');
        accounts = await response.json();
        renderAccounts();
    } catch (error) {
        document.getElementById('accounts-list').innerHTML = `
            <div class="alert alert-danger">Error loading accounts: ${error.message}</div>
        `;
    }
}

async function renderAccounts() {
    if (accounts.length === 0) {
        document.getElementById('accounts-list').innerHTML = `
            <div class="alert alert-info">
                No accounts configured. Click "Add Account" to get started.
            </div>
        `;
        return;
    }
    
    // Fetch sync status for all accounts
    const syncStatuses = {};
    for (const account of accounts) {
        try {
            const response = await fetch(`/api/accounts/${account.id}/sync/status`);
            const status = await response.json();
            syncStatuses[account.id] = status;
        } catch (e) {
            syncStatuses[account.id] = { synced: false };
        }
    }
    
    let html = '<div class="list-group">';
    for (const account of accounts) {
        const status = syncStatuses[account.id] || { channel_count: 0 };
        
        // Format sync status - account is synced if it has channels
        const synced = (status.channel_count > 0);
        let syncBadge = '';
        let syncInfo = '';
        if (synced) {
            syncBadge = '<span class="badge bg-success" title="Database synced"><i class="bi bi-database-check"></i> Synced</span>';
            if (status.last_sync) {
                const syncDate = new Date(status.last_sync);
                const relativeTime = getRelativeTime(syncDate);
                syncInfo = `<br><small class="text-muted">Last sync: ${relativeTime} (${status.channel_count || 0} channels)</small>`;
            }
        } else {
            syncBadge = '<span class="badge bg-warning text-dark" title="Account not synced - using API calls only. Server does not provide a native m3u playlist, all requests go through the IPTV provider API."><i class="bi bi-cloud"></i> API Only</span>';
        }
        
        // Format credentials info
        const credentials = account.credentials || [];
        const totalConnections = account.total_max_connections || credentials.length || 1;
        let credentialsBadge = '';
        if (credentials.length > 1) {
            credentialsBadge = `<span class="badge bg-info" title="${credentials.length} credentials, ${totalConnections} total connections"><i class="bi bi-people"></i> ${credentials.length} credentials (${totalConnections} streams)</span>`;
        } else if (credentials.length === 1 && credentials[0].max_connections > 1) {
            credentialsBadge = `<span class="badge bg-info" title="${credentials[0].max_connections} max connections"><i class="bi bi-broadcast"></i> ${credentials[0].max_connections} streams</span>`;
        }
        
        html += `
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h5 class="mb-1">
                            ${account.name}
                            ${!account.enabled ? '<span class="badge bg-secondary">Disabled</span>' : ''}
                            ${syncBadge}
                            ${credentialsBadge}
                        </h5>
                        <p class="mb-1 text-muted">
                            <strong>Server:</strong> ${account.server}<br>
                            <strong>Username:</strong> ${account.username}
                            ${syncInfo}
                        </p>
                        <small>
                            <a href="/playlist/${account.id}.m3u" target="_blank">
                                <i class="bi bi-download"></i> Download M3U
                            </a>
                            |
                            <a href="/playlist/${account.id}.m3u?proxy=true" target="_blank" title="Proxied M3U (for DVR/PIP support)">
                                <i class="bi bi-shuffle"></i> Proxied M3U
                            </a>
                            |
                            <a href="/epg/${account.id}.xml" target="_blank">
                                <i class="bi bi-file-earmark-text"></i> EPG
                            </a>
                        </small>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-info" data-action="sync" data-account-id="${account.id}" title="Sync Channels to Database">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" data-action="reprocess-tags" data-account-id="${account.id}" title="Reprocess Tags (run after changing tag rules)">
                            <i class="bi bi-tags"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" data-action="test" data-account-id="${account.id}" title="Test Connection">
                            <i class="bi bi-activity"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" data-action="view-categories" data-account-id="${account.id}" title="View Categories">
                            <i class="bi bi-list-ul"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" data-action="manage-credentials" data-account-id="${account.id}" title="Manage Credentials">
                            <i class="bi bi-key"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" data-action="edit" data-account-id="${account.id}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" data-action="delete" data-account-id="${account.id}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    html += '</div>';
    document.getElementById('accounts-list').innerHTML = html;
}

// Helper function to format relative time
function getRelativeTime(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
}

// Setup event listeners when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    // Password toggle
    const togglePassword = document.getElementById('togglePassword');
    const passwordField = document.getElementById('accountPassword');
    if (togglePassword && passwordField) {
        togglePassword.addEventListener('click', () => {
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
            togglePassword.querySelector('i').className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
        });
    }

    // Add Account button
    const addBtn = document.getElementById('add-account-btn');
    if (addBtn) {
        addBtn.addEventListener('click', () => {
            document.getElementById('accountModalLabel').textContent = 'Add Account';
            document.getElementById('accountForm').reset();
            document.getElementById('accountId').value = '';
            document.getElementById('accountEnabled').checked = true;
            document.getElementById('accountPassword').required = true;
            document.getElementById('passwordHint').style.display = 'none';
        });
    }

    // Save Account button
    const saveBtn = document.getElementById('save-account-btn');
    if (saveBtn) {
        saveBtn.addEventListener('click', async () => {
            const id = document.getElementById('accountId').value;
            let server = document.getElementById('accountServer').value.trim();
            const password = document.getElementById('accountPassword').value;
            const userAgent = document.getElementById('accountUserAgent').value.trim();
            
            // Strip http:// or https:// and trailing slash from server
            server = server.replace(/^https?:\/\//, '').replace(/\/$/, '');
            
            const data = {
                name: document.getElementById('accountName').value,
                server: server,
                username: document.getElementById('accountUsername').value,
                enabled: document.getElementById('accountEnabled').checked
            };
            
            // Only include password if it's set
            if (password) {
                data.password = password;
            }
            
            // Include user_agent if provided
            if (userAgent) {
                data.user_agent = userAgent;
            }
            
            try {
                const url = id ? `/api/accounts/${id}` : '/api/accounts';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    modal.hide();
                    await loadAccounts();
                } else {
                    const error = await response.json();
                    alert('Error saving account: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });
    }

    // Event delegation for account action buttons
    const accountsList = document.getElementById('accounts-list');
    if (accountsList) {
        accountsList.addEventListener('click', async (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const action = button.dataset.action;
            const accountId = parseInt(button.dataset.accountId);
            const account = accounts.find(a => a.id === accountId);

            switch (action) {
                case 'edit':
                    if (!account) return;
                    document.getElementById('accountModalLabel').textContent = 'Edit Account';
                    document.getElementById('accountId').value = account.id;
                    document.getElementById('accountName').value = account.name;
                    document.getElementById('accountServer').value = account.server;
                    document.getElementById('accountUsername').value = account.username;
                    document.getElementById('accountPassword').value = '';
                    document.getElementById('accountPassword').placeholder = '••••••••';
                    document.getElementById('accountPassword').required = false;
                    document.getElementById('passwordHint').style.display = 'block';
                    document.getElementById('accountUserAgent').value = account.user_agent || '';
                    document.getElementById('accountEnabled').checked = account.enabled;
                    modal.show();
                    break;

                case 'delete':
                    if (!confirm('Are you sure you want to delete this account?')) return;
                    try {
                        const response = await fetch(`/api/accounts/${accountId}`, { method: 'DELETE' });
                        if (response.ok) {
                            await loadAccounts();
                        } else {
                            alert('Error deleting account');
                        }
                    } catch (error) {
                        alert('Error: ' + error.message);
                    }
                    break;

                case 'sync':
                    if (!confirm(`Sync channels for ${account?.name}? This may take a few minutes.`)) return;
                    try {
                        button.disabled = true;
                        button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                        
                        const response = await fetch(`/api/accounts/${accountId}/sync`, { method: 'POST' });
                        const result = await response.json();
                        
                        if (response.ok) {
                            const added = result.channels_added || 0;
                            const updated = result.channels_updated || 0;
                            const deactivated = result.channels_deactivated || 0;
                            const total = added + updated;
                            alert(`Sync complete!\n\nAdded: ${added}\nUpdated: ${updated}\nDeactivated: ${deactivated}\nTotal synced: ${total}`);
                            await loadAccounts();
                        } else {
                            alert('Error syncing channels: ' + (result.error || 'Unknown error'));
                        }
                    } catch (error) {
                        alert('Error: ' + error.message);
                    } finally {
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-arrow-repeat"></i>';
                    }
                    break;

                case 'reprocess-tags':
                    if (!confirm(`Reprocess tags for ${account?.name}? This will extract tags from all channels based on current tag rules. This may take a few minutes for large channel lists.`)) return;
                    try {
                        button.disabled = true;
                        button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                        
                        const response = await fetch(`/api/accounts/${accountId}/process-tags`, { method: 'POST' });
                        const result = await response.json();
                        
                        if (response.ok) {
                            const created = result.tags_created || 0;
                            const updated = result.tags_updated || 0;
                            const removed = result.tags_removed || 0;
                            const channelsUpdated = result.channels_updated || 0;
                            alert(`Tag reprocessing complete!\n\nTags created: ${created}\nTags updated: ${updated}\nTags removed: ${removed}\nChannels updated: ${channelsUpdated}`);
                            await loadAccounts();
                        } else {
                            alert('Error reprocessing tags: ' + (result.error || 'Unknown error'));
                        }
                    } catch (error) {
                        alert('Error: ' + error.message);
                    } finally {
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-tags"></i>';
                    }
                    break;

                case 'test':
                    try {
                        button.disabled = true;
                        button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                        
                        const response = await fetch(`/api/accounts/${accountId}/test`, { method: 'POST' });
                        const result = await response.json();
                        if (result.success) {
                            let msg = `Connection successful!\n\nChannels: ${result.channels || 0}\nCategories: ${result.categories || 0}\n`;
                            
                            // Show credential results if available
                            if (result.credentials && result.credentials.length > 0) {
                                msg += `\nCredentials:\n`;
                                for (const cred of result.credentials) {
                                    if (cred.success) {
                                        msg += `• ${cred.username}: ${cred.max_connections} connection(s), ${cred.status || 'Unknown'}\n`;
                                    } else {
                                        msg += `• ${cred.username}: FAILED - ${cred.error}\n`;
                                    }
                                }
                                msg += `\nTotal max connections: ${result.total_max_connections || 1}`;
                            } else if (result.user_info) {
                                msg += `\nMax connections: ${result.user_info.max_connections || 1}`;
                                msg += `\nStatus: ${result.user_info.status || 'Unknown'}`;
                            }
                            
                            alert(msg);
                            await loadAccounts();
                        } else {
                            alert('Connection failed: ' + (result.error || 'Unknown error'));
                        }
                    } catch (error) {
                        alert('Error: ' + error.message);
                    } finally {
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-activity"></i>';
                    }
                    break;
                
                case 'manage-credentials':
                    await showCredentialsModal(accountId, account?.name);
                    break;

                case 'view-categories':
                    try {
                        document.getElementById('categoriesContent').innerHTML = `
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        `;
                        categoriesModal.show();
                        
                        const response = await fetch(`/api/accounts/${accountId}/categories`);
                        const categories = await response.json();
                        
                        document.getElementById('categoriesModalLabel').textContent = 
                            `Categories - ${account ? account.name : 'Account'} (${categories.length} total)`;
                        
                        let html = `
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i>
                                <strong>Tip:</strong> Use <a href="/filters" class="alert-link">Filters</a> to show/hide specific categories or channels.
                            </div>
                            <div class="mb-3">
                                <input type="text" class="form-control" id="categorySearch" placeholder="Search categories...">
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px;">ID</th>
                                            <th>Category Name</th>
                                            <th style="width: 80px;" class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="categoriesTableBody">
                        `;
                        
                        for (const cat of categories) {
                            html += `
                                <tr class="category-row" data-category-name="${(cat.category_name || '').toLowerCase()}">
                                    <td>${cat.category_id || 'N/A'}</td>
                                    <td>${cat.category_name || 'Unnamed'}</td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-secondary" 
                                                onclick="addCategoryFilter(${accountId}, '${cat.category_name}')"
                                                title="Add as filter">
                                            <i class="bi bi-funnel-fill"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }
                        
                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                        
                        if (categories.length === 0) {
                            html = '<div class="alert alert-info">No categories found for this account.</div>';
                        }
                        
                        document.getElementById('categoriesContent').innerHTML = html;
                        
                        // Add search functionality
                        const searchInput = document.getElementById('categorySearch');
                        if (searchInput) {
                            searchInput.addEventListener('input', (e) => {
                                const searchTerm = e.target.value.toLowerCase();
                                const rows = document.querySelectorAll('.category-row');
                                rows.forEach(row => {
                                    const categoryName = row.dataset.categoryName;
                                    row.style.display = categoryName.includes(searchTerm) ? '' : 'none';
                                });
                            });
                        }
                    } catch (error) {
                        document.getElementById('categoriesContent').innerHTML = `
                            <div class="alert alert-danger">
                                <strong>Error fetching categories:</strong> ${error.message}
                            </div>
                        `;
                        console.error('Error fetching categories:', error);
                    }
                    break;
            }
        });
    }
    
    // Credential password toggle
    const toggleCredentialPassword = document.getElementById('toggleCredentialPassword');
    const credentialPasswordField = document.getElementById('credentialPassword');
    if (toggleCredentialPassword && credentialPasswordField) {
        toggleCredentialPassword.addEventListener('click', () => {
            const type = credentialPasswordField.getAttribute('type') === 'password' ? 'text' : 'password';
            credentialPasswordField.setAttribute('type', type);
            toggleCredentialPassword.querySelector('i').className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
        });
    }
    
    // Add credential button
    const addCredBtn = document.getElementById('add-credential-btn');
    if (addCredBtn) {
        addCredBtn.addEventListener('click', () => {
            document.getElementById('credentialEditModalLabel').textContent = 'Add Credential';
            document.getElementById('credentialForm').reset();
            document.getElementById('credentialId').value = '';
            document.getElementById('credentialAccountId').value = currentCredentialsAccountId;
            document.getElementById('credentialEnabled').checked = true;
            document.getElementById('credentialPassword').required = true;
            document.getElementById('credentialPasswordHint').style.display = 'none';
            credentialEditModal.show();
        });
    }
    
    // Save credential button
    const saveCredBtn = document.getElementById('save-credential-btn');
    if (saveCredBtn) {
        saveCredBtn.addEventListener('click', async () => {
            const credId = document.getElementById('credentialId').value;
            const accountId = document.getElementById('credentialAccountId').value;
            const password = document.getElementById('credentialPassword').value;
            
            const data = {
                username: document.getElementById('credentialUsername').value,
                enabled: document.getElementById('credentialEnabled').checked
            };
            
            if (password) {
                data.password = password;
            }
            
            try {
                const url = credId 
                    ? `/api/accounts/${accountId}/credentials/${credId}` 
                    : `/api/accounts/${accountId}/credentials`;
                const method = credId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    credentialEditModal.hide();
                    await loadCredentials(accountId);
                    await loadAccounts();  // Refresh main list to show updated credential count
                } else {
                    const error = await response.json();
                    alert('Error saving credential: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });
    }
});

async function showCredentialsModal(accountId, accountName) {
    currentCredentialsAccountId = accountId;
    document.getElementById('credentialsModalLabel').textContent = `Manage Credentials - ${accountName || 'Account'}`;
    document.getElementById('credentialsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    credentialsModal.show();
    await loadCredentials(accountId);
}

async function loadCredentials(accountId) {
    try {
        const response = await fetch(`/api/accounts/${accountId}/credentials`);
        const credentials = await response.json();
        
        let html = '';
        
        if (credentials.length === 0) {
            html = '<div class="alert alert-warning">No credentials found. Add one to get started.</div>';
        } else {
            html = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Max Connections</th>
                                <th>Status</th>
                                <th>Expires</th>
                                <th>Enabled</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            for (const cred of credentials) {
                const expDate = cred.exp_date ? formatExpDate(cred.exp_date) : 'Unknown';
                const statusBadge = cred.status === 'Active' 
                    ? '<span class="badge bg-success">Active</span>'
                    : `<span class="badge bg-warning">${cred.status || 'Unknown'}</span>`;
                const enabledBadge = cred.enabled 
                    ? '<span class="badge bg-success">Yes</span>'
                    : '<span class="badge bg-secondary">No</span>';
                
                html += `
                    <tr>
                        <td>${cred.username}</td>
                        <td>${cred.max_connections || 1}</td>
                        <td>${statusBadge}</td>
                        <td>${expDate}</td>
                        <td>${enabledBadge}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-info" onclick="testCredential(${accountId}, ${cred.id})" title="Test Connection">
                                <i class="bi bi-activity"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="editCredential(${accountId}, ${cred.id}, '${cred.username}', ${cred.enabled})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCredential(${accountId}, ${cred.id})" title="Delete" ${credentials.length <= 1 ? 'disabled' : ''}>
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="alert alert-secondary mt-3">
                    <strong>Total connections available:</strong> ${credentials.reduce((sum, c) => sum + (c.max_connections || 1), 0)}
                </div>
            `;
        }
        
        document.getElementById('credentialsContent').innerHTML = html;
    } catch (error) {
        document.getElementById('credentialsContent').innerHTML = `
            <div class="alert alert-danger">
                <strong>Error loading credentials:</strong> ${error.message}
            </div>
        `;
    }
}

function formatExpDate(timestamp) {
    if (!timestamp) return 'Unknown';
    try {
        const date = new Date(parseInt(timestamp) * 1000);
        return date.toLocaleDateString();
    } catch {
        return timestamp;
    }
}

function editCredential(accountId, credId, username, enabled) {
    document.getElementById('credentialEditModalLabel').textContent = 'Edit Credential';
    document.getElementById('credentialId').value = credId;
    document.getElementById('credentialAccountId').value = accountId;
    document.getElementById('credentialUsername').value = username;
    document.getElementById('credentialPassword').value = '';
    document.getElementById('credentialPassword').required = false;
    document.getElementById('credentialPasswordHint').style.display = 'block';
    document.getElementById('credentialEnabled').checked = enabled;
    credentialEditModal.show();
}

async function testCredential(accountId, credId) {
    try {
        const response = await fetch(`/api/accounts/${accountId}/credentials/${credId}/test`, { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            const info = result.user_info;
            alert(`Credential test successful!\n\nUsername: ${info.username}\nMax connections: ${info.max_connections}\nStatus: ${info.status}\nExpires: ${formatExpDate(info.exp_date)}`);
            await loadCredentials(accountId);
            await loadAccounts();
        } else {
            alert('Test failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteCredential(accountId, credId) {
    if (!confirm('Are you sure you want to delete this credential?')) return;
    
    try {
        const response = await fetch(`/api/accounts/${accountId}/credentials/${credId}`, { method: 'DELETE' });
        
        if (response.ok) {
            await loadCredentials(accountId);
            await loadAccounts();
        } else {
            const error = await response.json();
            alert('Error deleting credential: ' + (error.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function addCategoryFilter(accountId, categoryName) {
    // Navigate to filters page with account and category pre-filled
    const params = new URLSearchParams({
        account: accountId,
        category: categoryName
    });
    window.location.href = `/filters?${params.toString()}`;
}

loadAccounts();
</script>
{% endblock %}
