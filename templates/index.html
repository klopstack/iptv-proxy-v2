{% extends "base.html" %}

{% block title %}Dashboard - IPTV Proxy{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
</div>

<div id="dashboard-content">
    <div class="row">
        <div class="col-md-12">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Loading statistics...
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function syncAccount(accountId, button) {
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Syncing...';
    
    try {
        const response = await fetch(`/api/accounts/${accountId}/sync`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const result = await response.json();
            // Reload dashboard to show updated stats
            loadDashboard();
        } else {
            const error = await response.json();
            alert('Sync failed: ' + (error.error || 'Unknown error'));
            button.disabled = false;
            button.innerHTML = originalText;
        }
    } catch (error) {
        alert('Error syncing account: ' + error.message);
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

function formatRelativeTime(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffSecs = Math.floor(diffMs / 1000);
    const diffMins = Math.floor(diffSecs / 60);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffSecs < 60) return 'just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    return date.toLocaleDateString();
}

async function loadDashboard() {
    try {
        const response = await fetch('/api/accounts');
        const accounts = await response.json();
        
        let html = '<div class="row">';
        
        if (accounts.length === 0) {
            html += `
                <div class="col-md-12">
                    <div class="alert alert-warning">
                        <h4><i class="bi bi-exclamation-triangle"></i> No Accounts Configured</h4>
                        <p>Get started by <a href="/accounts">adding an IPTV account</a>.</p>
                    </div>
                </div>
            `;
        } else {
            for (const account of accounts) {
                const statsResponse = await fetch(`/api/accounts/${account.id}/stats`);
                let stats = {};
                if (statsResponse.ok) {
                    stats = await statsResponse.json();
                }
                
                // Determine sync status
                const isSynced = stats.synced || false;
                const syncBadge = isSynced 
                    ? '<span class="badge bg-success"><i class="bi bi-database-check"></i> Synced</span>'
                    : '<span class="badge bg-warning text-dark"><i class="bi bi-cloud"></i> Not Synced</span>';
                
                let syncInfo = '';
                if (isSynced && stats.last_sync) {
                    const syncDate = new Date(stats.last_sync);
                    const relativeTime = formatRelativeTime(syncDate);
                    syncInfo = `<small class="text-muted">Last sync: ${relativeTime}</small><br>`;
                }
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card ${account.enabled ? '' : 'border-secondary'}">
                            <div class="card-header ${account.enabled ? 'bg-primary text-white' : 'bg-secondary text-white'}">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-server"></i> ${account.name}
                                    ${!account.enabled ? '<span class="badge bg-dark">Disabled</span>' : ''}
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    <strong>Server:</strong> ${account.server}<br>
                                    <strong>Username:</strong> ${account.username}<br>
                                    <strong>Status:</strong> ${syncBadge}<br>
                                    ${syncInfo}
                                </p>
                                ${stats.total_channels !== undefined ? `
                                    <div class="mb-2">
                                        <strong>Total Channels:</strong> ${stats.total_channels.toLocaleString()}<br>
                                        ${stats.visible_channels !== undefined ? `
                                            <strong>Visible:</strong> <span class="text-success">${stats.visible_channels.toLocaleString()}</span><br>
                                            <strong>Hidden:</strong> <span class="text-danger">${stats.hidden_channels.toLocaleString()}</span><br>
                                        ` : ''}
                                        <strong>Categories:</strong> ${stats.total_categories}
                                    </div>
                                ` : ''}
                                <div class="d-grid gap-2">
                                    ${account.enabled ? `
                                        <button onclick="syncAccount(${account.id}, this)" class="btn btn-sm btn-primary">
                                            <i class="bi bi-arrow-repeat"></i> Sync Channels
                                        </button>
                                        <a href="/playlist/${account.id}.m3u" 
                                           class="btn btn-sm btn-success ${!isSynced ? 'disabled' : ''}" 
                                           target="_blank"
                                           ${!isSynced ? 'onclick="return false;" title="Please sync first"' : 'title="Download complete playlist with filters applied"'}>
                                            <i class="bi bi-download"></i> Download M3U (Filtered)
                                        </a>
                                    ` : `
                                        <button class="btn btn-sm btn-secondary" disabled>
                                            Account Disabled
                                        </button>
                                    `}
                                    <a href="/test?account=${account.id}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> Preview Channels
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        html += '</div>';
        
        // Load and display tag playlists
        try {
            const playlistsResponse = await fetch('/api/playlist-configs');
            const playlists = await playlistsResponse.json();
            
            if (playlists.length > 0) {
                html += `
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="bi bi-collection-play"></i> Tag Playlists</h5>
                                    <a href="/rulesets#playlists" class="btn btn-sm btn-light">
                                        <i class="bi bi-gear"></i> Manage
                                    </a>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Tags</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                `;
                
                for (const playlist of playlists) {
                    const tagBadges = playlist.include_tags.slice(0, 3)
                        .map(t => `<span class="badge bg-primary me-1">${escapeHtml(t)}</span>`)
                        .join('');
                    const moreTags = playlist.include_tags.length > 3 
                        ? `<span class="badge bg-secondary">+${playlist.include_tags.length - 3} more</span>` 
                        : '';
                    
                    const playlistUrl = `/playlist/config/${playlist.slug}.m3u`;
                    
                    html += `
                        <tr>
                            <td>
                                <strong>${escapeHtml(playlist.name)}</strong>
                                ${!playlist.enabled ? '<span class="badge bg-secondary ms-1">Disabled</span>' : ''}
                            </td>
                            <td>${tagBadges}${moreTags}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="${playlistUrl}" target="_blank" class="btn btn-outline-success" title="Download playlist">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    <button class="btn btn-outline-secondary" onclick="copyToClipboard('${window.location.origin}${playlistUrl}')" title="Copy URL">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
                
                html += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        } catch (e) {
            // Silently fail if playlists can't be loaded
            console.error('Error loading tag playlists:', e);
        }
        
        // Add quick links
        html += `
            <div class="row mt-4">
                <div class="col-md-12">
                    <h3>Quick Actions</h3>
                    <div class="list-group">
                        <a href="/accounts" class="list-group-item list-group-item-action">
                            <i class="bi bi-plus-circle"></i> Add New Account
                        </a>
                        <a href="/filters" class="list-group-item list-group-item-action">
                            <i class="bi bi-funnel-fill"></i> Manage Filters
                        </a>
                        <a href="/rulesets" class="list-group-item list-group-item-action">
                            <i class="bi bi-tags-fill"></i> Manage Tags & Rulesets
                        </a>
                        <a href="/rulesets#playlists" class="list-group-item list-group-item-action">
                            <i class="bi bi-collection-play"></i> Tag Playlists
                        </a>
                        <a href="/settings" class="list-group-item list-group-item-action">
                            <i class="bi bi-gear-fill"></i> Settings & Scheduler
                        </a>
                        <a href="/test" class="list-group-item list-group-item-action">
                            <i class="bi bi-play-circle"></i> Test Playlists
                        </a>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('dashboard-content').innerHTML = html;
    } catch (error) {
        document.getElementById('dashboard-content').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Error loading dashboard: ${error.message}
            </div>
        `;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Brief visual feedback
        const toast = document.createElement('div');
        toast.className = 'position-fixed bottom-0 end-0 p-3';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <div class="toast show" role="alert">
                <div class="toast-body bg-success text-white rounded">
                    <i class="bi bi-check-circle"></i> URL copied to clipboard!
                </div>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    }).catch(err => {
        alert('Failed to copy: ' + err.message);
    });
}

loadDashboard();
</script>
{% endblock %}
