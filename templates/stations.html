{% extends "base.html" %}

{% block title %}Station Database - IPTV Proxy{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-broadcast"></i> Station Database</h1>
    <div>
        <button class="btn btn-outline-info me-2" onclick="loadFccStats()">
            <i class="bi bi-arrow-repeat"></i> Refresh Stats
        </button>
        <button class="btn btn-primary" onclick="syncFccData()" id="fcc-sync-btn">
            <i class="bi bi-cloud-download"></i> Sync FCC Data
        </button>
    </div>
</div>

<!-- Info Alert -->
<div class="alert alert-info mb-4">
    <i class="bi bi-info-circle"></i>
    <strong>FCC Station Database</strong> provides authoritative registration data for US TV stations.
    Use this data to enrich channels with location/network tags, match EPG callsigns to cities, and create market-based playlists.
    <a href="https://enterpriseefiling.fcc.gov/dataentry/public/tv/lmsDatabase.html" target="_blank" class="alert-link">
        <i class="bi bi-box-arrow-up-right"></i> FCC LMS Database
    </a>
</div>

<div class="row">
    <!-- Left Column: Stats and Enrichment -->
    <div class="col-lg-8">
        <!-- Database Status Card -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-database-fill"></i> Database Status
            </div>
            <div class="card-body" id="fcc-status">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Channel Enrichment Card -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-magic"></i> Channel Enrichment</span>
            </div>
            <div class="card-body">
                <p class="mb-3">
                    Automatically add location, network, and callsign tags to channels based on FCC station data.
                    This matches channel names containing callsigns or city names to the FCC database.
                </p>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="enrichAccountSelect" class="form-label">Account</label>
                        <select class="form-select" id="enrichAccountSelect">
                            <option value="">Select an account...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Options</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enrichAddNetwork" checked>
                            <label class="form-check-label" for="enrichAddNetwork">Add network tags (ABC, NBC, CBS...)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enrichAddLocation" checked>
                            <label class="form-check-label" for="enrichAddLocation">Add location tags (city, state)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enrichAddDma" checked>
                            <label class="form-check-label" for="enrichAddDma">Add DMA/market tags</label>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="previewEnrichment()">
                        <i class="bi bi-eye"></i> Preview Changes
                    </button>
                    <button class="btn btn-success" onclick="applyEnrichment()" id="apply-enrichment-btn">
                        <i class="bi bi-check-circle"></i> Apply Enrichment
                    </button>
                </div>
                <div id="enrichment-results" class="mt-3"></div>
            </div>
        </div>

        <!-- Station Lookup Card -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-search"></i> Station Lookup
            </div>
            <div class="card-body">
                <ul class="nav nav-pills mb-3" id="fcc-lookup-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="pill" href="#lookup-callsign">By Callsign</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="pill" href="#lookup-city">By City</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="pill" href="#lookup-dma">By DMA/Market</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="lookup-callsign">
                        <div class="input-group">
                            <input type="text" class="form-control" id="fcc-callsign-input" 
                                   placeholder="e.g., KABC-TV, WNBC" onkeypress="if(event.key==='Enter')lookupCallsign()">
                            <button class="btn btn-outline-primary" onclick="lookupCallsign()">
                                <i class="bi bi-search"></i> Lookup
                            </button>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="lookup-city">
                        <div class="row g-2">
                            <div class="col-md-5">
                                <input type="text" class="form-control" id="fcc-city-input" 
                                       placeholder="City (e.g., Los Angeles)">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="fcc-state-input" 
                                       placeholder="State (e.g., CA)" maxlength="2">
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-primary w-100" onclick="lookupCity()">
                                    <i class="bi bi-search"></i> Search
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="lookup-dma">
                        <div class="input-group">
                            <input type="text" class="form-control" id="fcc-dma-input" 
                                   placeholder="e.g., New York, Los Angeles, Denver" onkeypress="if(event.key==='Enter')lookupDma()">
                            <button class="btn btn-outline-primary" onclick="lookupDma()">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                    </div>
                </div>
                <div id="fcc-lookup-results" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Right Column: Info and DMA List -->
    <div class="col-lg-4">
        <!-- About Card -->
        <div class="card bg-light mb-4">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> About FCC Station Data
            </div>
            <div class="card-body">
                <p class="small">
                    The FCC Licensing and Management System (LMS) database contains authoritative registration 
                    information for all licensed US TV stations.
                </p>
                <h6>Use Cases</h6>
                <ul class="small mb-3">
                    <li><strong>Callsign → City</strong>: Find the city for an EPG callsign to match channel names</li>
                    <li><strong>City → Callsigns</strong>: Find all stations in a city for playlist filtering</li>
                    <li><strong>Tag enrichment</strong>: Auto-add location/network tags to channels</li>
                    <li><strong>Market playlists</strong>: Create playlists for specific DMAs (markets)</li>
                </ul>
                <h6>Data Fields</h6>
                <ul class="small mb-0">
                    <li><strong>Callsign</strong>: Station identifier (e.g., KABC-TV)</li>
                    <li><strong>City/State</strong>: Licensed community of service</li>
                    <li><strong>Network</strong>: Affiliation (ABC, NBC, CBS, FOX...)</li>
                    <li><strong>DMA</strong>: Nielsen Designated Market Area</li>
                    <li><strong>Channel</strong>: RF and virtual channel numbers</li>
                </ul>
            </div>
        </div>

        <!-- Popular DMAs Card -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-geo-alt"></i> Popular DMAs
            </div>
            <div class="card-body" id="popular-dmas">
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// Utility Functions
// ============================================================================

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, m => map[m]);
}

// ============================================================================
// FCC Stats and Sync
// ============================================================================

async function loadFccStats() {
    const statusDiv = document.getElementById('fcc-status');
    
    try {
        const response = await fetch('/api/fcc/facilities/stats');
        const stats = await response.json();
        
        if (stats.total_facilities === 0) {
            statusDiv.innerHTML = `
                <div class="alert alert-warning mb-0">
                    <i class="bi bi-exclamation-triangle"></i> No FCC data loaded yet.
                    Click "Sync FCC Data" to download the latest TV station information (~40MB download).
                </div>
            `;
            return;
        }
        
        const lastSync = stats.last_sync ? new Date(stats.last_sync).toLocaleString() : 'Unknown';
        const serviceBreakdown = Object.entries(stats.by_service_code || {})
            .map(([code, count]) => `<span class="badge bg-secondary me-1">${code}: ${count.toLocaleString()}</span>`)
            .join('');
        
        const topNetworks = Object.entries(stats.top_networks || {})
            .slice(0, 10)
            .map(([network, count]) => `<tr><td>${network || '<em>Independent</em>'}</td><td class="text-end">${count.toLocaleString()}</td></tr>`)
            .join('');
        
        statusDiv.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h5 class="mb-3"><i class="bi bi-bar-chart"></i> Overview</h5>
                    <p class="mb-2">
                        <strong>Total Facilities:</strong> ${stats.total_facilities.toLocaleString()}<br>
                        <strong>Last Synced:</strong> ${lastSync}
                    </p>
                    <p class="mb-0">
                        <strong>By Service Code:</strong><br>
                        ${serviceBreakdown}
                    </p>
                </div>
                <div class="col-md-6">
                    <h5 class="mb-3"><i class="bi bi-broadcast-pin"></i> Top Networks</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0">
                            <thead><tr><th>Network</th><th class="text-end">Stations</th></tr></thead>
                            <tbody>${topNetworks}</tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        // Also load popular DMAs
        loadPopularDmas(stats);
        
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-danger mb-0">Error loading FCC stats: ${error.message}</div>`;
    }
}

function loadPopularDmas(stats) {
    const dmasDiv = document.getElementById('popular-dmas');
    
    if (!stats.top_dmas || stats.top_dmas.length === 0) {
        dmasDiv.innerHTML = '<p class="text-muted small mb-0">Sync FCC data to see popular markets</p>';
        return;
    }
    
    const dmaList = stats.top_dmas.slice(0, 15).map(([dma, count]) => `
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-1" 
           onclick="document.getElementById('fcc-dma-input').value='${dma}';lookupDma();return false;">
            <small>${dma}</small>
            <span class="badge bg-primary rounded-pill">${count}</span>
        </a>
    `).join('');
    
    dmasDiv.innerHTML = `<div class="list-group list-group-flush">${dmaList}</div>`;
}

async function syncFccData() {
    const btn = document.getElementById('fcc-sync-btn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Syncing...';
    
    const statusDiv = document.getElementById('fcc-status');
    statusDiv.innerHTML = `
        <div class="alert alert-info">
            <span class="spinner-border spinner-border-sm me-2"></span>
            Downloading FCC facility data (~40MB)... This may take a minute.
        </div>
    `;
    
    try {
        const response = await fetch('/api/fcc/facilities/sync', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> ${result.message}<br>
                    <small>Added: ${result.stats.added.toLocaleString()}, Updated: ${result.stats.updated.toLocaleString()}, Unchanged: ${result.stats.unchanged.toLocaleString()}</small>
                </div>
            `;
            // Reload stats after sync
            setTimeout(loadFccStats, 1500);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ${result.error || result.message}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-danger">Error syncing FCC data: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}

// ============================================================================
// Station Lookup
// ============================================================================

async function lookupCallsign() {
    const callsign = document.getElementById('fcc-callsign-input').value.trim();
    if (!callsign) {
        alert('Please enter a callsign');
        return;
    }
    
    const resultsDiv = document.getElementById('fcc-lookup-results');
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div></div>';
    
    try {
        // Fetch FCC data and matching channels in parallel
        const [fccResponse, channelsResponse] = await Promise.all([
            fetch(`/api/fcc/facilities/lookup/callsign/${encodeURIComponent(callsign)}`),
            fetch(`/api/fcc/channels/by-callsign/${encodeURIComponent(callsign)}`)
        ]);
        
        const data = await fccResponse.json();
        const channelsData = await channelsResponse.json();
        
        if (data.error) {
            resultsDiv.innerHTML = `<div class="alert alert-warning mb-0">${data.error}</div>`;
            return;
        }
        
        // Build channels section if any found
        let channelsHtml = '';
        if (channelsData.total_channels > 0) {
            channelsHtml = `
                <div class="mt-3 pt-3 border-top">
                    <h6 class="mb-2"><i class="bi bi-tv"></i> Matching Channels (${channelsData.total_channels})</h6>
                    ${channelsData.accounts.map(acc => `
                        <div class="mb-2">
                            <small class="text-muted">${acc.account_name}</small>
                            <div class="list-group list-group-flush">
                                ${acc.channels.map(ch => `
                                    <div class="list-group-item d-flex justify-content-between align-items-center py-1 px-2">
                                        <span class="text-truncate me-2" style="max-width: 300px;" title="${ch.name}">
                                            ${ch.cleaned_name || ch.name}
                                        </span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    onclick="downloadStreamPlaylist(${acc.account_id}, '${ch.stream_id}', '${escapeHtml(ch.cleaned_name || ch.name).replace(/'/g, "\\'")}')" 
                                                    title="Download playlist (opens in VLC/media player)">
                                                <i class="bi bi-play-fill"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" 
                                                    onclick="copyStreamUrl(${acc.account_id}, '${ch.stream_id}')"
                                                    title="Copy stream URL">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        resultsDiv.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">${data.callsign}</h5>
                    <div class="row">
                        <div class="col-6">
                            <table class="table table-sm mb-0">
                                <tr><th>City</th><td>${data.city}, ${data.state}</td></tr>
                                <tr><th>Network</th><td>${data.network || '<em>Independent</em>'}</td></tr>
                                <tr><th>DMA</th><td>${data.dma || 'N/A'}</td></tr>
                            </table>
                        </div>
                        <div class="col-6">
                            <table class="table table-sm mb-0">
                                <tr><th>Channel</th><td>${data.channel || 'N/A'}${data.virtual_channel ? ' (Virtual: ' + data.virtual_channel + ')' : ''}</td></tr>
                                <tr><th>Service</th><td><span class="badge bg-secondary">${data.service_code}</span></td></tr>
                                <tr><th>Active</th><td>${data.active ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td></tr>
                            </table>
                        </div>
                    </div>
                    ${channelsHtml}
                </div>
            </div>
        `;
    } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger mb-0">Error: ${error.message}</div>`;
    }
}

// Download M3U playlist file for stream (opens in media player)
function downloadStreamPlaylist(accountId, streamId, channelName) {
    const url = `${window.location.origin}/stream/${accountId}/${streamId}.ts`;
    const m3uContent = `#EXTM3U\n#EXTINF:-1,${channelName || 'Stream'}\n${url}`;
    
    const blob = new Blob([m3uContent], { type: 'audio/x-mpegurl' });
    const downloadUrl = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = downloadUrl;
    a.download = `${channelName || streamId}.m3u`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(downloadUrl);
}

// Copy stream URL to clipboard
function copyStreamUrl(accountId, streamId) {
    const url = `${window.location.origin}/stream/${accountId}/${streamId}.ts`;
    navigator.clipboard.writeText(url).then(() => {
        // Show brief toast or feedback
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i>';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-secondary');
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 1000);
    });
}

async function lookupCity() {
    const city = document.getElementById('fcc-city-input').value.trim();
    const state = document.getElementById('fcc-state-input').value.trim().toUpperCase();
    
    if (!city || !state) {
        alert('Please enter both city and state');
        return;
    }
    
    const resultsDiv = document.getElementById('fcc-lookup-results');
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div></div>';
    
    try {
        const response = await fetch(`/api/fcc/facilities/lookup/city?city=${encodeURIComponent(city)}&state=${encodeURIComponent(state)}`);
        const data = await response.json();
        
        if (data.count === 0) {
            resultsDiv.innerHTML = `<div class="alert alert-warning mb-0">No stations found in ${city}, ${state}</div>`;
            return;
        }
        
        const rows = data.facilities.map(f => `
            <tr>
                <td>
                    <a href="#" onclick="lookupAndShowChannels('${f.callsign}'); return false;" 
                       class="text-decoration-none" title="Click to see matching channels">
                        <strong>${f.callsign}</strong> <i class="bi bi-search small"></i>
                    </a>
                </td>
                <td>${f.network || '<em>Independent</em>'}</td>
                <td>${f.channel || 'N/A'}${f.virtual_channel ? ' (' + f.virtual_channel + ')' : ''}</td>
                <td><span class="badge bg-secondary">${f.service_code}</span></td>
            </tr>
        `).join('');
        
        resultsDiv.innerHTML = `
            <div class="card">
                <div class="card-header">${data.count} station(s) in ${data.city}, ${data.state}</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead><tr><th>Callsign</th><th>Network</th><th>Channel</th><th>Service</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                </div>
                <div id="city-channels-detail" class="card-footer d-none"></div>
            </div>
        `;
    } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger mb-0">Error: ${error.message}</div>`;
    }
}

async function lookupDma() {
    const dma = document.getElementById('fcc-dma-input').value.trim();
    
    if (!dma) {
        alert('Please enter a DMA/market name');
        return;
    }
    
    const resultsDiv = document.getElementById('fcc-lookup-results');
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div></div>';
    
    try {
        const response = await fetch(`/api/fcc/facilities/lookup/dma?dma=${encodeURIComponent(dma)}`);
        const data = await response.json();
        
        if (data.count === 0) {
            resultsDiv.innerHTML = `<div class="alert alert-warning mb-0">No stations found in "${dma}" DMA</div>`;
            return;
        }
        
        const rows = data.facilities.slice(0, 100).map(f => `
            <tr>
                <td>
                    <a href="#" onclick="lookupAndShowChannels('${f.callsign}'); return false;" 
                       class="text-decoration-none" title="Click to see matching channels">
                        <strong>${f.callsign}</strong> <i class="bi bi-search small"></i>
                    </a>
                </td>
                <td>${f.city}, ${f.state}</td>
                <td>${f.network || '<em>Independent</em>'}</td>
                <td>${f.channel || 'N/A'}</td>
            </tr>
        `).join('');
        
        resultsDiv.innerHTML = `
            <div class="card">
                <div class="card-header">${data.count} station(s) in "${data.dma}" DMA${data.count > 100 ? ' (showing first 100)' : ''}</div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead style="position: sticky; top: 0; background: var(--bg-card);"><tr><th>Callsign</th><th>City</th><th>Network</th><th>Channel</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                </div>
                <div id="dma-channels-detail" class="card-footer d-none"></div>
            </div>
        `;
    } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger mb-0">Error: ${error.message}</div>`;
    }
}

// Look up and display matching channels for a callsign (from city/DMA list clicks)
async function lookupAndShowChannels(callsign) {
    try {
        const response = await fetch(`/api/fcc/channels/by-callsign/${encodeURIComponent(callsign)}`);
        const data = await response.json();
        
        // Find where to show the results (check for either detail div)
        const detailDiv = document.getElementById('city-channels-detail') || 
                        document.getElementById('dma-channels-detail');
        
        if (!detailDiv) {
            // Fallback: show in an alert modal
            if (data.total_channels === 0) {
                alert(`No channels found matching ${callsign}`);
            } else {
                const channels = data.accounts.flatMap(acc => 
                    acc.channels.map(ch => `${acc.account_name}: ${ch.name}`)
                ).join('\n');
                alert(`Channels matching ${callsign}:\n\n${channels}`);
            }
            return;
        }
        
        if (data.total_channels === 0) {
            detailDiv.innerHTML = `
                <div class="alert alert-info mb-0 py-2">
                    <i class="bi bi-info-circle"></i> No channels found matching <strong>${callsign}</strong>
                </div>
            `;
        } else {
            detailDiv.innerHTML = `
                <h6 class="mb-2"><i class="bi bi-tv"></i> Channels matching <strong>${callsign}</strong> (${data.total_channels})</h6>
                ${data.accounts.map(acc => `
                    <div class="mb-2">
                        <small class="text-muted">${acc.account_name}</small>
                        <div class="list-group list-group-flush">
                            ${acc.channels.map(ch => `
                                <div class="list-group-item d-flex justify-content-between align-items-center py-1 px-2">
                                    <span class="text-truncate me-2" style="max-width: 300px;" title="${ch.name}">
                                        ${ch.cleaned_name || ch.name}
                                    </span>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary btn-sm" 
                                                onclick="downloadStreamPlaylist(${acc.account_id}, '${ch.stream_id}', '${escapeHtml(ch.cleaned_name || ch.name).replace(/'/g, "\\'")}')" 
                                                title="Download playlist (opens in VLC/media player)">
                                            <i class="bi bi-play-fill"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" 
                                                onclick="copyStreamUrl(${acc.account_id}, '${ch.stream_id}')"
                                                title="Copy stream URL">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        detailDiv.classList.remove('d-none');
    } catch (error) {
        console.error('Error looking up channels:', error);
    }
}

// ============================================================================
// Channel Enrichment
// ============================================================================

// Enrichment lazy loading state
let enrichmentAccountId = null;
let enrichmentOffset = 0;
let enrichmentTotal = 0;
let enrichmentHasMore = false;
let enrichmentLoading = false;
const ENRICHMENT_PAGE_SIZE = 50;

async function loadAccounts() {
    try {
        const response = await fetch('/api/accounts');
        const accounts = await response.json();
        const select = document.getElementById('enrichAccountSelect');
        
        accounts.forEach(acc => {
            const option = document.createElement('option');
            option.value = acc.id;
            option.textContent = `${acc.name} (${acc.channel_count || 0} channels)`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load accounts:', error);
    }
}

async function previewEnrichment() {
    const accountId = document.getElementById('enrichAccountSelect').value;
    if (!accountId) {
        alert('Please select an account');
        return;
    }
    
    // Reset state for new preview
    enrichmentAccountId = accountId;
    enrichmentOffset = 0;
    enrichmentTotal = 0;
    enrichmentHasMore = false;
    
    const resultsDiv = document.getElementById('enrichment-results');
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> Analyzing channels...</div>';
    
    const options = {
        add_network: document.getElementById('enrichAddNetwork').checked,
        add_location: document.getElementById('enrichAddLocation').checked,
        add_dma: document.getElementById('enrichAddDma').checked
    };
    
    try {
        const response = await fetch(`/api/fcc/enrichment/preview/${accountId}?limit=${ENRICHMENT_PAGE_SIZE}&offset=0&` + new URLSearchParams(options));
        const data = await response.json();
        
        if (data.error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
        }
        
        if (data.total_matches === 0) {
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <strong>No channels matched FCC station data.</strong>
                    <ul class="mb-0 mt-2">
                        <li>Only channels tagged with "US" are checked for FCC enrichment</li>
                        <li>Channels must have recognizable callsigns (e.g., KABC, WNBC)</li>
                        <li>Run tag extraction first to ensure channels have proper tags</li>
                    </ul>
                </div>`;
            return;
        }
        
        // Update state
        enrichmentTotal = data.total_matches;
        enrichmentOffset = data.showing;
        enrichmentHasMore = data.has_more;
        
        // Build initial table
        resultsDiv.innerHTML = `
            <div class="alert alert-success">
                <strong>${data.total_matches}</strong> channels can be enriched with FCC data.
            </div>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;" id="enrichment-table-container">
                <table class="table table-sm">
                    <thead style="position: sticky; top: 0; background: var(--bg-card);"><tr><th>Channel</th><th>Callsign Match</th><th>Potential Tags</th></tr></thead>
                    <tbody id="enrichment-table-body"></tbody>
                </table>
                <div id="enrichment-loading" class="text-center py-3" style="display: none;">
                    <div class="spinner-border spinner-border-sm"></div> Loading more...
                </div>
            </div>
            <div class="text-muted small mt-2" id="enrichment-count">Showing ${data.showing} of ${data.total_matches} matches</div>
        `;
        
        // Render first batch
        renderEnrichmentRows(data.matches);
        
        // Setup scroll listener for lazy loading
        setupEnrichmentScrollListener();
        
    } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    }
}

function renderEnrichmentRows(matches) {
    const tbody = document.getElementById('enrichment-table-body');
    if (!tbody) return;
    
    const rows = matches.map(s => `
        <tr>
            <td>
                <a href="/stream/${s.account_id}/${s.stream_id}.ts" target="_blank" class="btn btn-sm btn-outline-success me-1" title="Play stream">
                    <i class="bi bi-play-fill"></i>
                </a>
                <small>${escapeHtml(s.channel_name)}</small>
            </td>
            <td>${s.extracted_callsign || 'N/A'} → ${s.fcc_callsign || ''}</td>
            <td>${(s.potential_tags || []).map(t => '<span class="badge bg-success me-1">' + t + '</span>').join('')}</td>
        </tr>
    `).join('');
    
    tbody.innerHTML += rows;
}

function setupEnrichmentScrollListener() {
    const container = document.getElementById('enrichment-table-container');
    if (!container) return;
    
    container.addEventListener('scroll', async () => {
        if (enrichmentLoading || !enrichmentHasMore) return;
        
        // Load more when within 100px of bottom
        if (container.scrollHeight - container.scrollTop - container.clientHeight < 100) {
            await loadMoreEnrichment();
        }
    });
}

async function loadMoreEnrichment() {
    if (enrichmentLoading || !enrichmentHasMore || !enrichmentAccountId) return;
    
    enrichmentLoading = true;
    const loadingIndicator = document.getElementById('enrichment-loading');
    if (loadingIndicator) loadingIndicator.style.display = 'block';
    
    const options = {
        add_network: document.getElementById('enrichAddNetwork').checked,
        add_location: document.getElementById('enrichAddLocation').checked,
        add_dma: document.getElementById('enrichAddDma').checked
    };
    
    try {
        const response = await fetch(`/api/fcc/enrichment/preview/${enrichmentAccountId}?limit=${ENRICHMENT_PAGE_SIZE}&offset=${enrichmentOffset}&` + new URLSearchParams(options));
        const data = await response.json();
        
        if (data.error) {
            console.error('Error loading more enrichment:', data.error);
            return;
        }
        
        // Update state
        enrichmentOffset += data.showing;
        enrichmentHasMore = data.has_more;
        
        // Render new rows
        renderEnrichmentRows(data.matches);
        
        // Update count display
        const countDisplay = document.getElementById('enrichment-count');
        if (countDisplay) {
            countDisplay.textContent = `Showing ${enrichmentOffset} of ${enrichmentTotal} matches`;
        }
        
    } catch (error) {
        console.error('Error loading more enrichment:', error);
    } finally {
        enrichmentLoading = false;
        if (loadingIndicator && !enrichmentHasMore) {
            loadingIndicator.style.display = 'none';
        }
    }
}

async function applyEnrichment() {
    const accountId = document.getElementById('enrichAccountSelect').value;
    if (!accountId) {
        alert('Please select an account');
        return;
    }
    
    if (!confirm('This will add FCC-derived tags to channels. Continue?')) {
        return;
    }
    
    const btn = document.getElementById('apply-enrichment-btn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Applying...';
    
    const resultsDiv = document.getElementById('enrichment-results');
    
    const options = {
        add_network: document.getElementById('enrichAddNetwork').checked,
        add_location: document.getElementById('enrichAddLocation').checked,
        add_dma: document.getElementById('enrichAddDma').checked
    };
    
    try {
        const response = await fetch(`/api/fcc/enrichment/apply/${accountId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(options)
        });
        const data = await response.json();
        
        if (data.error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
        }
        
        resultsDiv.innerHTML = `
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i> Enrichment complete!<br>
                <strong>${data.channels_matched}</strong> channels enriched with <strong>${data.channel_tags_added}</strong> new tags.
            </div>
        `;
    } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}

// ============================================================================
// Initialization
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    loadFccStats();
    loadAccounts();
});
</script>
{% endblock %}
