{% extends "base.html" %}

{% block title %}Preview Channels - IPTV Proxy{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">Preview Channels</h1>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Select Account</h5>
            </div>
            <div class="card-body">
                <select class="form-select mb-3" id="testAccountId">
                    <option value="">Select an account...</option>
                </select>
                
                <div class="mb-3">
                    <label class="form-label">Filter by Tags</label>
                    <div id="previewTagSelector"></div>
                    <div class="form-text">Type to search and click to add tags. Channels must have at least one selected tag.</div>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="load-preview-btn">
                        <i class="bi bi-eye"></i> Preview Channels
                    </button>
                    <button class="btn btn-success" id="download-playlist-btn">
                        <i class="bi bi-download"></i> Download M3U
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mt-3" id="categoryFilterCard" style="display: none;">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-funnel-fill"></i> Category Filter</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <span id="categoryFilterName"></span>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearCategoryFilter()">
                        <i class="bi bi-x-circle"></i> Clear
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5>Active Filters</h5>
            </div>
            <div class="card-body" id="activeFilters">
                <p class="text-muted">Select an account to view filters</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Channel Preview</h5>
            </div>
            <div class="card-body">
                <div id="previewResult">
                    <p class="text-muted">Select an account and click "Preview Channels"</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Channel Detail Modal -->
<div class="modal fade" id="channelDetailModal" tabindex="-1" aria-labelledby="channelDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="channelDetailModalLabel">Channel Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="channelDetailContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let accounts = [];
let currentAccountId = null;
let totalChannels = 0;
let loadedChannels = 0;
const CHANNELS_PER_PAGE = 50;
let loadingMore = false;
let hasMore = true;
let tagSelector = null;

async function loadAccounts() {
    const response = await fetch('/api/accounts');
    accounts = await response.json();
    
    const select = document.getElementById('testAccountId');
    select.innerHTML = '<option value="">Select an account...</option>';
    select.innerHTML += '<option value="all">All Accounts</option>';
    
    for (const account of accounts) {
        if (account.enabled) {
            select.innerHTML += `<option value="${account.id}">${account.name}</option>`;
        }
    }
    
    // Check URL params
    const params = new URLSearchParams(window.location.search);
    const accountId = params.get('account');
    const tagName = params.get('tag');
    const categoryName = params.get('category');
    
    if (accountId) {
        select.value = accountId;
        
        // If a tag is specified, load it first then preview
        if (tagName) {
            await loadTagFromUrl(accountId, tagName);
        } else if (categoryName) {
            // Store category filter for use in loadPreview and show the filter card
            window.categoryFilter = categoryName;
            updateCategoryFilterUI();
            await loadPreview();
        } else {
            await loadPreview();
        }
    }
}

function updateCategoryFilterUI() {
    const card = document.getElementById('categoryFilterCard');
    const nameSpan = document.getElementById('categoryFilterName');
    
    if (window.categoryFilter) {
        card.style.display = 'block';
        nameSpan.innerHTML = `<span class="badge bg-info">${escapeHtml(window.categoryFilter)}</span>`;
    } else {
        card.style.display = 'none';
        nameSpan.innerHTML = '';
    }
}

function clearCategoryFilter() {
    window.categoryFilter = null;
    updateCategoryFilterUI();
    
    // Remove category from URL without reloading
    const url = new URL(window.location);
    url.searchParams.delete('category');
    window.history.replaceState({}, '', url);
    
    // Reload preview with the filter cleared
    loadPreview();
}

function initTagSelector() {
    if (tagSelector) return; // Already initialized
    
    tagSelector = new TagSelector({
        containerId: 'previewTagSelector',
        accountIdGetter: () => {
            const val = document.getElementById('testAccountId').value;
            // Return null for "all" so selector knows there's no specific account
            return val === 'all' ? null : val;
        },
        badgeClass: 'bg-primary',
        placeholder: 'Search tags...'
    });
}

async function loadTagFromUrl(accountId, tagName) {
    try {
        // Initialize tag selector first
        initTagSelector();
        
        // Fetch the specific tag to get its details
        const response = await fetch(`/api/accounts/${accountId}/tags/search?q=${encodeURIComponent(tagName)}&limit=1`);
        const tags = await response.json();
        
        if (tags.length > 0 && tags[0].name === tagName) {
            // Add the tag to the selector
            tagSelector.setTags([tags[0]]);
        }
        
        // Load preview with the tag filter
        await loadPreview();
    } catch (error) {
        console.error('Error loading tag from URL:', error);
        // Still try to load preview
        await loadPreview();
    }
}

async function loadPreview() {
    const accountId = document.getElementById('testAccountId').value;
    if (!accountId) return;
    
    // Initialize tag selector if needed
    initTagSelector();
    
    // Reset state
    currentAccountId = accountId;
    totalChannels = 0;
    loadedChannels = 0;
    hasMore = true;
    
    document.getElementById('previewResult').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status"></div>
            <p>Loading channels...</p>
        </div>
    `;
    
    // Load filters
    try {
        if (accountId === 'all') {
            document.getElementById('activeFilters').innerHTML = '<p class="text-muted">Viewing all accounts - filters vary by account</p>';
        } else {
            const filtersResponse = await fetch(`/api/accounts/${accountId}/filters`);
            const filters = await filtersResponse.json();
            
            let filtersHtml = '';
            if (filters.length === 0) {
                filtersHtml = '<p class="text-muted">No filters configured</p>';
            } else {
                filtersHtml = '<ul class="list-group list-group-flush">';
                for (const filter of filters.filter(f => f.enabled)) {
                    const badge = filter.filter_action === 'whitelist' ? 'success' : 'danger';
                    filtersHtml += `
                        <li class="list-group-item">
                            <span class="badge bg-${badge}">${filter.filter_action}</span>
                            <strong>${filter.filter_type}:</strong> ${filter.filter_value}
                        </li>
                    `;
                }
                filtersHtml += '</ul>';
            }
            document.getElementById('activeFilters').innerHTML = filtersHtml;
        }
    } catch (error) {
        document.getElementById('activeFilters').innerHTML = `<p class="text-danger">Error loading filters</p>`;
    }
    
    // Initialize display
    const html = `
        <div class="alert alert-info" id="channelCount">
            Loading channels...
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Icon</th>
                        <th>Channel Name</th>
                        <th>Cleaned Name</th>
                        <th>Category</th>
                        <th>Tags</th>
                        <th style="min-width: 90px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="channelsTableBody">
                </tbody>
            </table>
        </div>
        <div id="loadingIndicator" class="text-center my-3" style="min-height: 50px;">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading more...</span>
            </div>
            Loading more channels...
        </div>
    `;
    
    document.getElementById('previewResult').innerHTML = html;
    
    // Set up intersection observer
    setupInfiniteScroll();
    
    // Load first batch
    await loadMoreChannels();
}

async function loadMoreChannels() {
    if (loadingMore || !hasMore || !currentAccountId) return;
    
    loadingMore = true;
    const loadingIndicator = document.getElementById('loadingIndicator');
    if (loadingIndicator) loadingIndicator.style.display = 'block';
    
    try {
        // Get selected tags from the TagSelector component
        const selectedTagNames = tagSelector ? tagSelector.getTagNames() : [];
        const tagParam = selectedTagNames.length > 0 ? `&tags=${selectedTagNames.join(',')}` : '';
        
        // Get category filter if set from URL
        const categoryParam = window.categoryFilter ? `&category=${encodeURIComponent(window.categoryFilter)}` : '';
        
        // Use different endpoint for "all accounts"
        let url;
        if (currentAccountId === 'all') {
            url = `/api/channels/preview?limit=${CHANNELS_PER_PAGE}&offset=${loadedChannels}${tagParam}${categoryParam}`;
        } else {
            url = `/api/accounts/${currentAccountId}/preview?limit=${CHANNELS_PER_PAGE}&offset=${loadedChannels}${tagParam}${categoryParam}`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Update total on first load
        if (data.total > 0) {
            totalChannels = data.total;
        }
        
        // Show data source indicator on first load
        if (loadedChannels === 0) {
            const dataSourceBadge = data.using_database 
                ? '<span class="badge bg-success ms-2" title="Using local database"><i class="bi bi-database-check"></i> Database</span>'
                : '<span class="badge bg-warning text-dark ms-2" title="Using IPTV API"><i class="bi bi-cloud"></i> API</span>';
            
            const countDisplay = document.getElementById('channelCount');
            if (countDisplay) {
                countDisplay.innerHTML += dataSourceBadge;
            }
        }
        
        // Append channels to table
        const tbody = document.getElementById('channelsTableBody');
        let html = '';
        
        for (const channel of data.channels) {
            const tagsHtml = channel.tags && channel.tags.length > 0 
                ? channel.tags.map(tag => `<span class="badge bg-info me-1">${tag}</span>`).join('')
                : '<span class="text-muted">No tags</span>';
            
            // Show cleaned name if different from original
            const cleanedNameHtml = channel.cleaned_name && channel.cleaned_name !== channel.name
                ? `<div class="text-muted small">${channel.cleaned_name}</div>`
                : '';
            
            html += `
                <tr class="channel-row" style="cursor: pointer;" 
                    data-account-id="${channel.account_id}" 
                    data-stream-id="${channel.stream_id}"
                    title="Click for details">
                    <td>${channel.icon ? `<img src="${channel.icon}" width="40" height="30" onerror="this.style.display='none'">` : ''}</td>
                    <td>
                        ${escapeHtml(channel.name)}
                        ${cleanedNameHtml}
                    </td>
                    <td>${channel.cleaned_name ? escapeHtml(channel.cleaned_name) : '<span class="text-muted">-</span>'}</td>
                    <td><span class="badge bg-secondary">${escapeHtml(channel.category || 'Uncategorized')}</span></td>
                    <td>${tagsHtml}</td>
                    <td class="text-nowrap">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" data-action="create-tag-rule" data-channel-name="${escapeHtml(channel.name)}" data-channel-id="${channel.id}" title="Create tag rule for this channel" onclick="event.stopPropagation();">
                                <i class="bi bi-tag"></i>
                            </button>
                            <button class="btn btn-outline-info" data-action="view-details" data-account-id="${channel.account_id}" data-stream-id="${channel.stream_id}" title="View channel details" onclick="event.stopPropagation(); showChannelDetails('${channel.account_id}', '${channel.stream_id}');">
                                <i class="bi bi-info-circle"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        if (tbody) tbody.innerHTML += html;
        
        // Update state
        loadedChannels += data.showing;
        hasMore = data.has_more;
        
        // Update count display
        const countDisplay = document.getElementById('channelCount');
        if (countDisplay) {
            if (totalChannels > 0) {
                countDisplay.innerHTML = `Showing ${loadedChannels.toLocaleString()} of ${totalChannels.toLocaleString()} channels`;
            } else {
                countDisplay.innerHTML = `Loaded ${loadedChannels.toLocaleString()} channels`;
            }
        }
        
        // Hide loading indicator if no more channels
        if (!hasMore && loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
        
    } catch (error) {
        document.getElementById('previewResult').innerHTML = `
            <div class="alert alert-danger">
                Error loading channels: ${error.message}
            </div>
        `;
    }
    
    loadingMore = false;
}

function setupInfiniteScroll() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    if (!loadingIndicator) return;
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !loadingMore && hasMore) {
                loadMoreChannels();
            }
        });
    }, {
        root: null,
        rootMargin: '200px',
        threshold: 0.1
    });
    
    observer.observe(loadingIndicator);
}

function downloadPlaylist() {
    const accountId = document.getElementById('testAccountId').value;
    if (!accountId) {
        alert('Please select an account first');
        return;
    }
    
    if (accountId === 'all') {
        alert('Please select a specific account to download playlist. "All Accounts" view is for preview only.');
        return;
    }
    
    window.open(`/playlist/${accountId}.m3u`, '_blank');
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

function createManualTagRule(channelName) {
    const accountId = document.getElementById('testAccountId').value;
    if (!accountId) {
        alert('Please select an account first');
        return;
    }
    
    // Create a regex pattern that matches this exact channel name
    // Escape special regex characters
    const escapedName = channelName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const pattern = `^${escapedName}$`;
    
    // Create URL parameters for pre-filling the tag rule form
    const params = new URLSearchParams({
        account_id: accountId,
        rule_name: `Manual tag for ${channelName}`,
        pattern: pattern,
        pattern_type: 'regex',
        source: 'channel_name',
        remove_from_name: 'false',
        from_test_page: 'true'
    });
    
    // Open rulesets page in new tab with pre-filled parameters
    window.open(`/rulesets?${params.toString()}`, '_blank');
}

async function showChannelDetails(accountId, streamId) {
    const modal = new bootstrap.Modal(document.getElementById('channelDetailModal'));
    const contentDiv = document.getElementById('channelDetailContent');
    
    // Show loading state
    contentDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    try {
        const response = await fetch(`/api/accounts/${accountId}/channels/${streamId}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const channel = await response.json();
        
        // Format tags
        const tagsHtml = channel.tags && channel.tags.length > 0
            ? channel.tags.map(tag => `<span class="badge bg-info me-1">${escapeHtml(tag)}</span>`).join('')
            : '<span class="text-muted">No tags</span>';
        
        // Format dates
        const formatDate = (dateStr) => {
            if (!dateStr) return '<span class="text-muted">-</span>';
            const date = new Date(dateStr);
            return date.toLocaleString();
        };
        
        // Format boolean values
        const formatBool = (val) => val 
            ? '<span class="badge bg-success">Yes</span>' 
            : '<span class="badge bg-secondary">No</span>';
        
        // Update modal title
        document.getElementById('channelDetailModalLabel').textContent = channel.cleaned_name || channel.name;
        
        // Build detail view
        contentDiv.innerHTML = `
            <div class="row">
                <div class="col-md-4 text-center mb-3">
                    ${channel.stream_icon 
                        ? `<img src="${channel.stream_icon}" class="img-fluid rounded mb-2" style="max-height: 150px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                           <div class="text-muted" style="display:none;"><i class="bi bi-image" style="font-size: 4rem;"></i><br>No icon available</div>`
                        : '<div class="text-muted"><i class="bi bi-image" style="font-size: 4rem;"></i><br>No icon available</div>'
                    }
                </div>
                <div class="col-md-8">
                    <h5 class="mb-1">${escapeHtml(channel.name)}</h5>
                    ${channel.cleaned_name && channel.cleaned_name !== channel.name 
                        ? `<p class="text-muted mb-2">Cleaned: ${escapeHtml(channel.cleaned_name)}</p>` 
                        : ''}
                    <div class="mb-2">
                        <span class="badge bg-secondary">${escapeHtml(channel.category)}</span>
                        <span class="badge bg-primary ms-1">${escapeHtml(channel.account_name)}</span>
                    </div>
                    <div class="mb-2">${tagsHtml}</div>
                </div>
            </div>
            
            <hr>
            
            <div class="row">
                <div class="col-md-6">
                    <h6 class="border-bottom pb-2">Stream Information</h6>
                    <table class="table table-sm">
                        <tr>
                            <th style="width: 40%">Stream ID</th>
                            <td><code>${escapeHtml(channel.stream_id)}</code></td>
                        </tr>
                        <tr>
                            <th>Stream Type</th>
                            <td>${channel.stream_type ? escapeHtml(channel.stream_type) : '<span class="text-muted">-</span>'}</td>
                        </tr>
                        <tr>
                            <th>EPG Channel ID</th>
                            <td>${channel.epg_channel_id ? `<code>${escapeHtml(channel.epg_channel_id)}</code>` : '<span class="text-muted">-</span>'}</td>
                        </tr>
                        <tr>
                            <th>Custom SID</th>
                            <td>${channel.custom_sid ? `<code>${escapeHtml(channel.custom_sid)}</code>` : '<span class="text-muted">-</span>'}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6 class="border-bottom pb-2">Archive & Status</h6>
                    <table class="table table-sm">
                        <tr>
                            <th style="width: 40%">TV Archive</th>
                            <td>${formatBool(channel.tv_archive)}</td>
                        </tr>
                        <tr>
                            <th>Archive Duration</th>
                            <td>${channel.tv_archive_duration ? channel.tv_archive_duration + ' days' : '<span class="text-muted">-</span>'}</td>
                        </tr>
                        <tr>
                            <th>Active</th>
                            <td>${formatBool(channel.is_active)}</td>
                        </tr>
                        <tr>
                            <th>Visible</th>
                            <td>${formatBool(channel.is_visible)}</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <h6 class="border-bottom pb-2">Metadata</h6>
                    <table class="table table-sm">
                        <tr>
                            <th style="width: 20%">Added (from provider)</th>
                            <td>${channel.added ? formatDate(channel.added * 1000) : '<span class="text-muted">Unknown</span>'}</td>
                        </tr>
                        <tr>
                            <th>Last Seen</th>
                            <td>${formatDate(channel.last_seen)}</td>
                        </tr>
                        <tr>
                            <th>Created At</th>
                            <td>${formatDate(channel.created_at)}</td>
                        </tr>
                        <tr>
                            <th>Updated At</th>
                            <td>${formatDate(channel.updated_at)}</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            ${channel.direct_source ? `
            <div class="row">
                <div class="col-12">
                    <h6 class="border-bottom pb-2">Direct Source URL</h6>
                    <div class="input-group">
                        <input type="text" class="form-control form-control-sm" value="${escapeHtml(channel.direct_source)}" readonly>
                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="navigator.clipboard.writeText('${escapeHtml(channel.direct_source)}'); this.innerHTML='<i class=\\'bi bi-check\\'></i> Copied!';">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
            </div>
            ` : ''}
        `;
    } catch (error) {
        console.error('Error loading channel details:', error);
        contentDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle-fill"></i> 
                Error loading channel details: ${escapeHtml(error.message)}
            </div>
        `;
    }
}

loadAccounts();

// Initialize event listeners after DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    // Load Preview button
    const loadPreviewBtn = document.getElementById('load-preview-btn');
    if (loadPreviewBtn) {
        loadPreviewBtn.addEventListener('click', () => loadPreview());
    }

    // Download Playlist button
    const downloadBtn = document.getElementById('download-playlist-btn');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', () => downloadPlaylist());
    }

    // Event delegation for channel operations (create tag rule)
    document.getElementById('previewResult').addEventListener('click', (e) => {
        const tagRuleButton = e.target.closest('button[data-action="create-tag-rule"]');
        if (tagRuleButton) {
            const channelName = tagRuleButton.dataset.channelName;
            createManualTagRule(channelName);
            return;
        }
        
        // Handle row click for channel details
        const channelRow = e.target.closest('.channel-row');
        if (channelRow && !e.target.closest('button')) {
            const accountId = channelRow.dataset.accountId;
            const streamId = channelRow.dataset.streamId;
            showChannelDetails(accountId, streamId);
        }
    });

    // Account selector change - clear tags when account changes
    const testAccountSelect = document.getElementById('testAccountId');
    if (testAccountSelect) {
        testAccountSelect.addEventListener('change', () => {
            if (tagSelector) tagSelector.clear();
        });
    }
    
    // Initialize tag selector on page load
    initTagSelector();
});
</script>
{% endblock %}
